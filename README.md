## Quality control analysis of DIA data using [DIA-NN 1.9.1](https://github.com/vdemichev/DiaNN/releases/tag/1.9.1) search results

Please, note that the column names are slightly different in `report.tsv` and `report.parquet` files. Some importante informations are only available in the `report.parquet`.
You can download the .qmd document and place it in the same folder as the report.parquet file.

To have an in depth understanding of what is happening in this script, please check the [DIANN documentation](https://github.com/vdemichev/DiaNN), as well as the original publication of the QuantUMS algorithm by Demichev's group:
>Franziska Kistner, Justus L. Grossmann, Ludwig R. Sinn, Vadim Demichev. QuantUMS: uncertainty minimisation enables confident quantification in proteomics. bioRxiv 2023.06.20.545604; doi: https://doi.org/10.1101/2023.06.20.545604.

Maybe it is worth to check the [diann R package](https://github.com/vdemichev/diann-rpackage) that we are using to extract the matrix of abundance from the DIANN report with MaxLFQ values.

Make sure you have the following packages installed and loaded:
```
library(diann) # to extract the MaxLFQ matrix from DIANN report
library(arrow)  # to read the report.parquet file
library(here) # to avoid the need for use the path while loading the data
library(tidyverse)  # to do the data wrangling, plots, etc...
library(ggpointdensity) # to reconstruct the m/z density map
library(naniar) # for sparsity analysis
library(limma)  # for statistics (normalization)
```

## Load and filter the data from DIANN 1.9.1 search results
The file recommended to be used is the `report.parquet` generated by the DIANN search.
At the loading, we filter the data by the Q-values of the library, library protein group and protein group. It is important to use the same cut-off for Q-values at the Protein Group and Library Protein Group.

Information from DIANN documentation:
- `Quantity.Quality:` when using QuantUMS is equal to 1.0 / (1.0 + SD), where SD is the standard deviation of the LC-MS-derived error in relative precursor quantification.
- `Empirical.Quality:` when using QuantUMS reflects the agreement of relative precursor quantities obtained using different quantitative features (MS1 / fragment ions).
- `PG.MaxLFQ.Quality:` when using QuantUMS reflects the quality of PG.MaxLFQ.

Load the output data from DIANN search using the arrow function `read_parquet()`.

[!NOTE]

The File.Name column was removed from the output of the `report.parquet`, so we need to recreate it in order to make the file compatible with `dann_matrix()` function.

```
diann_report <- arrow::read_parquet("report.parquet") %>%
    dplyr::filter(PG.MaxLFQ.Quality >= 0.75 & Lib.PG.Q.Value <= 0.01 & Lib.Q.Value <= 0.01 & PG.Q.Value <= 0.01) %>%
  dplyr::mutate(File.Name = Run)

# extracting the matrix of abundance from DIANN report.parquet file
# observe that if we select the id.header as "Protein.Ids" or "Protein.Group" we will have different results because of the way DIANN makes the protein inference.
unique_genes <- diann::diann_matrix(diann_report,
    id.header = "Protein.Ids",
    quantity.header = "Genes.MaxLFQ.Unique",
    proteotypic.only = TRUE,
    pg.q = .01
)

# count the number of proteins per sample and save it in a new data frame called proteins
proteins <- diann_report %>%
    dplyr::group_by(Run) %>%
    dplyr::summarise(
        n_proteins = n_distinct(Protein.Ids)
    )
```

If it is necessary to use the data in other pipelines, you can write a tsv file filtered for the whole data and for the matrix.
The files will be saved in the working directory and can be inspected in Excel, for instance.

```
readr::write_tsv(diann_report, "diann_report_QuantUMS.tsv")
readr::write_tsv(unique_genes, "diann_matrix_QuantUMS.tsv")
```

For the reconstruction of the ion chromatograms, the precursor quantity is plotted over the retention time (min) for each sample.
[!TIP]
You can generate a new column for `condition, group, etc.` and add the `color = condition` to the `aes()`, for instance.

```
precursor_rt <- diann_report %>%
    ggplot(aes(x = RT, y = Precursor.Quantity)) +
    geom_line(aes(color = Run), show.legend = FALSE) +
    labs(
        x = "Retention time (min)",
        y = "Precursor quantity",
        color = NULL
    ) +
    facet_wrap(~Run)

ggsave("precursor_rt.png",
    path = "plots",
    precursor_rt, width = 15,
    height = 10, units = "in", dpi = 350)
```

Plot the m/z map to show the density of ions collected over the scan range and retention time.
It can be very informative of instability in dpray or chromatographic setup in general.

```
mz_map_density_plot <- diann_report %>%
    ggplot(aes(x = RT, y = Precursor.Mz)) +
    ggpointdensity::geom_pointdensity(size = 0.25) +
    viridis::scale_color_viridis(option = "plasma") +
    scale_x_continuous(limits = c(0, 90)) + # replace 90 with the length of the gradient
    labs(
        x = "Retention time (min)",
        y = " Scan range (m/z)",
        color = NULL
    ) +
    theme(legend.position = "bottom",
        legend.key.width = unit(1.5, "cm")) +
    facet_wrap(~Run)

ggsave("mz_map_density_plot.png",
    path = "plots",
    mz_map_density_plot, width = 15,
    height = 10, units = "in", dpi = 350)
```

The charge state distribution can be informative in experiments using FAIMS, for instance.

```{r}
precursor_charge_density <- diann_report %>%
    ggplot(aes(x = Precursor.Charge, fill = Run)) +
    geom_density(alpha = 0.7, 
            stat = "density", 
            show.legend = FALSE) +
    labs(
        x = "Precursor charge",
        y = "Density",
        fill = NULL
    ) +
    facet_wrap(~Run)

ggsave("precursor_charge_density.png",
    path = "plots",
    precursor_charge_density, width = 10,
    height = 10, units = "in", dpi = 350)
```
